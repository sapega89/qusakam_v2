# Работа с существующей структурой каньона

## Текущая ситуация

Каньон состоит из **более чем 4 сцен/комнат** в Metroidvania System.

## Что уже сделано

### 1. Canyon.gd обновлен
- ✅ Добавлена функция `_determine_initial_state()` для определения состояния на основе room_id
- ✅ Автоматически определяет, в какой сцене каньона находится игрок
- ✅ Устанавливает правильное начальное состояние

### 2. RelicArmor создан
- ✅ Интерактивный объект для обладунков
- ✅ Диалог `RelicArmor_Examine.dqd` создан
- ✅ Готов к добавлению в сцену с реликвией

### 3. AbductionZoneTrigger создан
- ✅ Триггер зоны для катсцены
- ✅ Готов к добавлению в сцену медитации

## Как использовать с существующей структурой

### Шаг 1: Определить структуру каньона

1. Открыть **MetSys Editor** в Godot:
   - `Project → Tools → Metroidvania System → Open Map Editor`
2. Найти все комнаты каньона (поиск по "canyon" или координатам)
3. Записать их room_id:
   - Например: `canyon_start`, `canyon_meditation`, `canyon_relic`, и т.д.

### Шаг 2: Добавить объекты в нужные сцены

**Для крайней сцены каньона (room_id содержит "relic", "relik", "end", "exit" или "final"):**
1. Открыть крайнюю сцену каньона (у выхода в пустыню) в Godot Editor
2. Добавить Area2D → назвать `RelicArmor`
3. Присвоить скрипт: `SampleProject/Scripts/Gameplay/RelicArmor.gd`
4. Добавить CollisionShape2D (CircleShape2D, radius: 50)
5. Настроить dialogue_id: "RelicArmor_Examine"
6. Разместить рядом с местом реликвии (у края каньона, перед выходом в пустыню)

**Для сцены с медитацией (room_id содержит "meditation" или "medit"):**
1. Открыть сцену в Godot Editor
2. Добавить Area2D → назвать `AbductionZoneTrigger`
3. Присвоить скрипт: `SampleProject/Scripts/Gameplay/AbductionZoneTrigger.gd`
4. Добавить CollisionShape2D (RectangleShape2D)
5. Разместить в зоне, где должна сработать катсцена

**Для крайней сцены каньона (у выхода в пустыню):**
1. Открыть крайнюю сцену каньона в Godot Editor
2. Добавить Area2D → назвать `CanyonExitTrigger`
3. Присвоить скрипт: `SampleProject/Scripts/Gameplay/CanyonExitTrigger.gd`
4. Добавить CollisionShape2D (RectangleShape2D)
5. Настроить `target_room: "DesertRoad.tscn"` (или другой room_id для пустыни)
6. Разместить у края каньона, перед выходом в пустыню
7. При входе игрока в зону показывается катсцена спуска с каньона, затем переход в пустыню

**Для всех сцен каньона:**
1. Убедиться, что есть SavePoint в группе "save_points"
2. Убедиться, что есть RoomInstance с правильным room_id

### Шаг 3: Настроить SavePoint'ы

Для каждой сцены каньона:
- **Сцена начала:** SavePoint для спавна при новой игре
- **Сцена медитации:** SavePoint (опционально, если нужен спавн после возврата)
- **Сцена реликвии:** SavePoint для спавна при возврате из деревни

### Шаг 4: Проверить переходы

Убедиться, что Portal'ы настроены правильно:
- Из сцены начала → сцена медитации
- Из сцены медитации → Village
- Из Village → сцена реликвии
- Из сцены реликвии → DesertRoad

## Автоматическое определение состояния

Canyon.gd автоматически определяет состояние на основе room_id:

```gdscript
# Если room_id содержит "relic", "relik", "end", "exit" или "final" → State.RELIC_PICKUP
# (Крайняя сцена каньона с обладунками)
# Если room_id содержит "meditation" или "medit" → State.EXPLORATION
# Иначе → State.INTRO
```

**Важно:** Обладунки находятся в **крайней сцене каньона**, у выхода в пустыню.

Это означает, что при загрузке сцены каньона автоматически устанавливается правильное состояние на основе того, в какой сцене находится игрок.

### Как это работает:

1. При загрузке сцены каньона вызывается `_determine_initial_state()`
2. Функция проверяет `MetSys.current_room.room_id`
3. На основе room_id устанавливается соответствующее состояние
4. Запускается соответствующий диалог/логика

## Проверка

После настройки проверить:
1. ✅ Игрок спавнится на правильном SavePoint в каждой сцене
2. ✅ При входе в AbductionZoneTrigger запускается катсцена
3. ✅ При нажатии E на RelicArmor запускается диалог
4. ✅ Переходы между сценами работают корректно
5. ✅ Состояния определяются правильно на основе room_id
